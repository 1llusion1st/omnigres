$schema: "https://raw.githubusercontent.com/omnigres/omnigres/master/pg_yregress/schema.json"
instance:
  init:
  - create extension omni_txn cascade
  - create extension dblink
  - select dblink_connect('another_session', 'hostaddr=127.0.0.1 dbname=yregress user=yregress port=' || (select setting
                                                                                                          from pg_settings
                                                                                                          where name = 'port'))
  - create table inventory
    (
        id           serial primary key,
        product_name text,
        quantity     int
    )
  - insert into inventory (product_name, quantity)
    values ('Widget', 100)
  - |
    create or replace function call_other_session() returns void
        language plpgsql as
    $$
    begin
        perform dblink_exec('another_session',
                            'call omni_txn.retry($other$update inventory set quantity = quantity - 10$other$)');
        return;
    end;
    $$
  - create table retries
    (
        count int
    )

tests:

- name: other errors pass through
  transaction: false
  tests:
  - query: call omni_txn.retry($$selec$$)
    transaction: false
    error: syntax error at or near "selec"
  - rollback

- name: can't be used inside of a transaction block
  tests:
  - query: call omni_txn.retry($$selec$$)
    transaction: false
    error: can't be used inside of a transaction block

- name: smoke test for retry
  transaction: false
  tests:
  - query: |
      call omni_txn.retry($$select quantity from inventory where product_name = 'Widget';
      select call_other_session() where omni_txn.current_retry_attempt() = 0;
      update inventory set quantity = quantity + 20 where product_name = 'Widget';
      insert into retries (count) select omni_txn.current_retry_attempt();
      $$);
    transaction: false
  - query: select quantity
           from inventory
           where product_name = 'Widget'
    results:
    - quantity: 110
  - query: select count
           from retries
    results:
    - count: 1

- name: max attempts
  transaction: false
  tests:
  - query: |
      call omni_txn.retry($$select quantity from inventory where product_name = 'Widget';
      select call_other_session() where omni_txn.current_retry_attempt() = 0;
      update inventory set quantity = quantity + 20 where product_name = 'Widget';
      $$, max_attempts => 0);
    transaction: false
    error: maximum number of retries (0) has been attempted
  - rollback
